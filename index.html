
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CYBER-Coin Wallet</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-black text-green-400 min-h-screen flex items-center justify-center">

<div class="bg-zinc-900 rounded-2xl shadow-xl p-6 w-full max-w-lg text-center">
<h1 class="text-3xl font-bold mb-2">ðŸš€ CYBER-Coin Wallet</h1>
<p class="text-sm text-zinc-400 mb-4">Live Kurs + Wallet</p>

<div id="price" class="text-5xl font-mono mb-2">LÃ¤dt...</div>
<p class="text-xs text-zinc-500 mb-4">1 CYBER = CHF</p>

<canvas id="chart" height="120"></canvas>

<div class="mt-4">
<input id="amount" type="number" placeholder="Menge" class="w-full bg-black border border-zinc-700 rounded-xl p-2 text-center">
<button onclick="convert()" class="mt-2 bg-green-500 text-black px-3 py-2 rounded-xl hover:bg-green-400">Umrechnen</button>
<p id="result" class="mt-2 text-zinc-400"></p>
</div>

<div class="mt-6 border-t border-zinc-700 pt-4">
<h2 class="font-bold mb-2">Wallet</h2>
<p id="wallet" class="mb-2 text-zinc-400">0 CYBER</p>

<button onclick="startBuy()" class="bg-blue-500 px-3 py-2 rounded-xl hover:bg-blue-400 mr-2">Coins kaufen</button>
<button onclick="redeemCoins()" class="bg-red-500 px-3 py-2 rounded-xl hover:bg-red-400">Coins einlÃ¶sen</button>

<button onclick="downloadWallet()" class="bg-yellow-500 px-3 py-2 rounded-xl hover:bg-yellow-400 mt-2">Wallet herunterladen</button>
<input type="file" id="uploadFile" style="display:none;" onchange="uploadWallet(event)">
<button onclick="document.getElementById('uploadFile').click()" class="bg-purple-500 px-3 py-2 rounded-xl hover:bg-purple-400 mt-2">Wallet hochladen</button>

<div class="mt-4" id="twintDiv" style="display:none;">
<p class="text-xs text-zinc-400 mb-1">Scanne QR fÃ¼r TWINT:</p>
<img src="twint-qr.png" alt="TWINT QR" class="mx-auto rounded-xl max-w-[200px]"/>
<button onclick="confirmPayment()" class="mt-2 bg-green-500 px-3 py-2 rounded-xl hover:bg-green-400">Ich habe bezahlt</button>
</div>

</div>
<p class="mt-4 text-xs text-zinc-600" id="updated"></p>
</div>

<script>
const apiURL = "https://cyber-coin-2026.vercel.app/api-price";
const verifyAPI = "https://cyber-coin-2026.vercel.app/api-verify-payment";

let chart, prices=[], labels=[], currentPrice=0;
let pendingCoins = 0;
let paymentID = "";

// Wallet
function getWallet(){return Number(localStorage.getItem("cyberWallet")||0);}
function setWallet(value){localStorage.setItem("cyberWallet",value); document.getElementById("wallet").innerText=value.toFixed(3)+" CYBER";}
setWallet(getWallet());

// Live Price
async function loadPrice(){
  try{
    const res = await fetch(apiURL);
    const data = await res.json();
    currentPrice = data.price_chf;
    document.getElementById("price").innerText=currentPrice.toFixed(3);
    document.getElementById("updated").innerText="Letztes Update: "+new Date(data.updated).toLocaleTimeString();
    prices.push(currentPrice); labels.push(new Date().toLocaleTimeString());
    if(prices.length>30){prices.shift(); labels.shift();}
    updateChart();
  }catch{document.getElementById("price").innerText="Server Fehler";}
}
function updateChart(){
  const ctx = document.getElementById("chart");
  if(!chart){chart=new Chart(ctx,{type:"line",data:{labels,datasets:[{data:prices,borderColor:"#22c55e",tension:0.3}]},options:{plugins:{legend:{display:false}},scales:{x:{display:false}}}});}
  else{chart.data.labels=labels; chart.data.datasets[0].data=prices; chart.update();}
}
function convert(){
  const amount=Number(document.getElementById("amount").value);
  if(!amount||!currentPrice)return;
  document.getElementById("result").innerText=amount+" CYBER = "+(amount*currentPrice).toFixed(2)+" CHF";
}
setInterval(loadPrice,3000); loadPrice();

// Kaufprozess
function startBuy(){
  const coins = Number(prompt("Wie viele CYBER-Coins kaufen?","10"));
  if(coins>0){
    pendingCoins = coins;
    paymentID = "pay_" + Date.now(); // eindeutige Payment-ID
    document.getElementById("twintDiv").style.display="block";
    alert("Bitte mit TWINT bezahlen! Deine Payment-ID: " + paymentID);
  }
}

// Coins freigeben nur nach server-side BestÃ¤tigung
async function confirmPayment(){
  if(!paymentID || pendingCoins<=0) return;
  try{
    const res = await fetch(`${verifyAPI}?id=${paymentID}`);
    const data = await res.json();
    if(data.success){
      setWallet(getWallet() + pendingCoins);
      alert(`${pendingCoins} CYBER-Coins wurden hinzugefÃ¼gt!`);
      pendingCoins=0; paymentID="";
      document.getElementById("twintDiv").style.display="none";
    } else {
      alert("Zahlung noch nicht bestÃ¤tigt!");
    }
  }catch{
    alert("Server Fehler bei der ZahlungsprÃ¼fung!");
  }
}

// EinlÃ¶sen
function redeemCoins(){
  const wallet=getWallet();
  const coinsToRedeem=Number(prompt("Wie viele CYBER-Coins einlÃ¶sen?",wallet));
  if(coinsToRedeem>0 && coinsToRedeem<=wallet){
    setWallet(wallet-coinsToRedeem);
    const chf=coinsToRedeem*currentPrice;
    alert(coinsToRedeem+" CYBER-Coins eingelÃ¶st = "+chf.toFixed(2)+" CHF");
  } else {alert("Nicht genug Coins im Wallet!");}
}

// Wallet export/import
function downloadWallet(){
  const wallet=getWallet();
  const data=JSON.stringify({wallet});
  const blob=new Blob([data],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="cyber-wallet.json"; a.click();
  URL.revokeObjectURL(url);
}
function uploadWallet(event){
  const file=event.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{const data=JSON.parse(e.target.result); if(data.wallet!==undefined){setWallet(data.wallet); alert("Wallet erfolgreich geladen!");}}
    catch{alert("UngÃ¼ltige Datei!");}
  };
  reader.readAsText(file);
}
</script>
</body>
</html>
